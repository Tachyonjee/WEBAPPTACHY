{% extends "shared/layout.html" %}

{% block title %}Lectures - Coaching App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h3><i class="fas fa-video me-2"></i>Lectures</h3>
        <p class="text-muted">Watch lectures and strengthen your concepts</p>
    </div>
</div>

<!-- Filter and Search -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <select class="form-select" id="subjectFilter" onchange="filterLectures()">
            <option value="">All Subjects</option>
            {% for subject in ['Physics', 'Chemistry', 'Mathematics'] + (['Biology'] if student.goal_exam == 'NEET' else []) %}
            <option value="{{ subject }}">{{ subject }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="col-md-3 mb-3">
        <input type="date" class="form-control" id="dateFilter" onchange="filterLectures()">
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="input-group">
            <input type="text" class="form-control" id="searchLectures" 
                   placeholder="Search lectures..." onkeyup="searchLectures()">
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <div class="col-md-2 mb-3">
        <button class="btn btn-outline-secondary w-100" onclick="clearAllFilters()">
            <i class="fas fa-filter me-1"></i>Clear All
        </button>
    </div>
</div>

<!-- Lectures Grid -->
<div class="row" id="lecturesContainer">
    {% if lectures %}
        {% for lecture in lectures %}
        <div class="col-lg-4 col-md-6 mb-4 lecture-card" 
             data-subject="{{ lecture.subject }}" 
             data-date="{{ lecture.date.isoformat() }}"
             data-title="{{ lecture.title.lower() }}">
            <div class="card h-100">
                <!-- Lecture Thumbnail -->
                <div class="lecture-thumbnail position-relative">
                    {% if lecture.resource_type == 'youtube' %}
                        {% set video_id = lecture.resource_url.split('/')[-1].split('=')[-1].split('&')[0] %}
                        <img src="https://img.youtube.com/vi/{{ video_id }}/maxresdefault.jpg" 
                             class="card-img-top" alt="{{ lecture.title }}" style="height: 200px; object-fit: cover;">
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <div class="btn btn-danger btn-lg rounded-circle">
                                <i class="fab fa-youtube"></i>
                            </div>
                        </div>
                    {% else %}
                        <div class="card-img-top d-flex align-items-center justify-content-center bg-dark" style="height: 200px;">
                            <div class="text-center">
                                <i class="fas fa-play-circle fa-4x text-primary mb-2"></i>
                                <p class="text-light mb-0">Video Lecture</p>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Duration Badge -->
                    {% if lecture.duration_minutes %}
                    <span class="position-absolute top-0 end-0 m-2 badge bg-dark">
                        {{ lecture.duration_minutes }} min
                    </span>
                    {% endif %}
                </div>
                
                <div class="card-body d-flex flex-column">
                    <!-- Lecture Info -->
                    <div class="mb-2">
                        <span class="badge bg-primary me-1">{{ lecture.subject }}</span>
                        <span class="badge bg-secondary">{{ lecture.date.strftime('%d %b %Y') }}</span>
                    </div>
                    
                    <!-- Title -->
                    <h5 class="card-title">{{ lecture.title }}</h5>
                    
                    <!-- Description/Notes -->
                    {% if lecture.notes %}
                    <p class="card-text text-muted">
                        {{ lecture.notes[:100] }}{% if lecture.notes|length > 100 %}...{% endif %}
                    </p>
                    {% endif %}
                    
                    <!-- Topics Covered -->
                    <div class="mb-2 flex-grow-1">
                        <small class="text-muted">Topics covered:</small>
                        <div class="mt-1">
                            <!-- Topics would be loaded from backend -->
                            <span class="badge bg-info me-1">Topic 1</span>
                            <span class="badge bg-info me-1">Topic 2</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="mt-auto">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" onclick="watchLecture({{ lecture.id }})">
                                <i class="fas fa-play me-2"></i>Watch Lecture
                            </button>
                            
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="viewLectureDetails({{ lecture.id }})">
                                    <i class="fas fa-info-circle me-1"></i>Details
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="getPracticeQuestions({{ lecture.id }})">
                                    <i class="fas fa-brain me-1"></i>Practice
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="addToWatchlist({{ lecture.id }})">
                                    <i class="fas fa-bookmark me-1"></i>Save
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-video fa-4x text-muted mb-3"></i>
                    <h5>No Lectures Available</h5>
                    <p class="text-muted mb-4">Lectures for your subjects will appear here when available</p>
                    <a href="{{ url_for('students.home') }}" class="btn btn-primary">
                        <i class="fas fa-home me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Empty State (for filtered results) -->
<div id="emptyState" class="d-none">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-search fa-4x text-muted mb-3"></i>
                <h5>No Lectures Found</h5>
                <p class="text-muted mb-4">Try adjusting your filters or search terms</p>
                <button type="button" class="btn btn-outline-primary" onclick="clearAllFilters()">
                    <i class="fas fa-times me-2"></i>Clear Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Watch Lecture Modal -->
<div class="modal fade" id="lectureModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lectureModalTitle">Lecture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="lecturePlayer">
                    <!-- Video player will be inserted here -->
                </div>
                
                <!-- Lecture Info -->
                <div class="p-4">
                    <div id="lectureInfo">
                        <!-- Lecture information will be loaded here -->
                    </div>
                    
                    <!-- Practice Recommendations -->
                    <div class="mt-4">
                        <h6><i class="fas fa-brain me-2"></i>Recommended Practice</h6>
                        <div id="practiceRecommendations">
                            <!-- Practice recommendations will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="startPracticeFromLecture()">
                    <i class="fas fa-brain me-2"></i>Start Practice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lecture Details Modal -->
<div class="modal fade" id="lectureDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lecture Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="lectureDetailsBody">
                <!-- Lecture details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="watchCurrentLecture()">
                    <i class="fas fa-play me-2"></i>Watch Lecture
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentLectureId = null;
let searchTimeout = null;

function filterLectures() {
    const subject = document.getElementById('subjectFilter').value;
    const date = document.getElementById('dateFilter').value;
    
    const cards = document.querySelectorAll('.lecture-card');
    let visibleCount = 0;
    
    cards.forEach(card => {
        let show = true;
        
        if (subject && card.dataset.subject !== subject) {
            show = false;
        }
        
        if (date && card.dataset.date !== date) {
            show = false;
        }
        
        card.style.display = show ? 'block' : 'none';
        if (show) visibleCount++;
    });
    
    toggleEmptyState(visibleCount === 0);
}

function searchLectures() {
    const query = document.getElementById('searchLectures').value.toLowerCase();
    
    // Clear previous timeout
    if (searchTimeout) clearTimeout(searchTimeout);
    
    // Debounce search
    searchTimeout = setTimeout(() => {
        const cards = document.querySelectorAll('.lecture-card');
        let visibleCount = 0;
        
        cards.forEach(card => {
            const title = card.dataset.title;
            const show = !query || title.includes(query);
            
            card.style.display = show ? 'block' : 'none';
            if (show) visibleCount++;
        });
        
        toggleEmptyState(visibleCount === 0);
    }, 300);
}

function clearSearch() {
    document.getElementById('searchLectures').value = '';
    searchLectures();
}

function clearAllFilters() {
    document.getElementById('subjectFilter').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('searchLectures').value = '';
    
    document.querySelectorAll('.lecture-card').forEach(card => {
        card.style.display = 'block';
    });
    
    toggleEmptyState(false);
}

function toggleEmptyState(show) {
    const container = document.getElementById('lecturesContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (show) {
        container.classList.add('d-none');
        emptyState.classList.remove('d-none');
    } else {
        container.classList.remove('d-none');
        emptyState.classList.add('d-none');
    }
}

function watchLecture(lectureId) {
    currentLectureId = lectureId;
    
    // Show loading state
    document.getElementById('lecturePlayer').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading lecture...</p>
        </div>
    `;
    
    // Load lecture details
    fetch(`/api/lectures/${lectureId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayLecture(data.lecture);
                loadPracticeRecommendations(lectureId);
            } else {
                showToast(data.error || 'Failed to load lecture', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading lecture:', error);
            showToast('Failed to load lecture', 'error');
        });
    
    new bootstrap.Modal(document.getElementById('lectureModal')).show();
}

function displayLecture(lecture) {
    // Update modal title
    document.getElementById('lectureModalTitle').textContent = lecture.title;
    
    // Display video player
    const playerContainer = document.getElementById('lecturePlayer');
    
    if (lecture.resource_type === 'youtube') {
        const embedUrl = lecture.embed_url || lecture.resource_url;
        playerContainer.innerHTML = `
            <div class="ratio ratio-16x9">
                <iframe src="${embedUrl}" 
                        title="${lecture.title}" 
                        allowfullscreen>
                </iframe>
            </div>
        `;
    } else {
        playerContainer.innerHTML = `
            <div class="ratio ratio-16x9">
                <video controls class="w-100">
                    <source src="${lecture.resource_url}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        `;
    }
    
    // Display lecture info
    document.getElementById('lectureInfo').innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <h5>${lecture.title}</h5>
                <div class="mb-2">
                    <span class="badge bg-primary me-2">${lecture.subject}</span>
                    <span class="badge bg-secondary">${lecture.date}</span>
                    ${lecture.duration_minutes ? `<span class="badge bg-info">${lecture.duration_minutes} min</span>` : ''}
                </div>
                ${lecture.notes ? `<p class="text-muted">${lecture.notes}</p>` : ''}
            </div>
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-body text-center">
                        <h6>Topics Covered</h6>
                        <div id="lectureTopics">
                            ${(lecture.topics || []).map(topic => 
                                `<span class="badge bg-info me-1 mb-1">${topic.topic}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function loadPracticeRecommendations(lectureId) {
    fetch(`/api/lectures/${lectureId}/recommendations`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPracticeRecommendations(data.recommendations);
            } else {
                document.getElementById('practiceRecommendations').innerHTML = 
                    '<p class="text-muted">No practice recommendations available</p>';
            }
        })
        .catch(error => {
            console.error('Error loading practice recommendations:', error);
            document.getElementById('practiceRecommendations').innerHTML = 
                '<p class="text-muted">Failed to load recommendations</p>';
        });
}

function displayPracticeRecommendations(recommendations) {
    const container = document.getElementById('practiceRecommendations');
    
    if (Object.keys(recommendations).length === 0) {
        container.innerHTML = '<p class="text-muted">No practice recommendations available</p>';
        return;
    }
    
    let html = '';
    
    Object.entries(recommendations).forEach(([topic, questions]) => {
        html += `
            <div class="mb-3">
                <h6 class="text-primary">${topic}</h6>
                <div class="row">
        `;
        
        questions.slice(0, 3).forEach(q => {
            html += `
                <div class="col-md-4 mb-2">
                    <div class="card card-body bg-dark">
                        <small class="text-muted">Level ${q.difficulty}</small>
                        <p class="small mb-2">${q.question_text}</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="practiceQuestion(${q.question_id})">
                            Practice
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function viewLectureDetails(lectureId) {
    currentLectureId = lectureId;
    
    fetch(`/api/lectures/${lectureId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayLectureDetails(data.lecture);
            } else {
                showToast(data.error || 'Failed to load lecture details', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading lecture details:', error);
            showToast('Failed to load lecture details', 'error');
        });
    
    new bootstrap.Modal(document.getElementById('lectureDetailsModal')).show();
}

function displayLectureDetails(lecture) {
    document.getElementById('lectureDetailsBody').innerHTML = `
        <div class="lecture-details">
            <div class="row">
                <div class="col-md-6">
                    <h5>${lecture.title}</h5>
                    <div class="mb-3">
                        <span class="badge bg-primary me-2">${lecture.subject}</span>
                        <span class="badge bg-secondary me-2">${lecture.date}</span>
                        ${lecture.duration_minutes ? `<span class="badge bg-info">${lecture.duration_minutes} min</span>` : ''}
                    </div>
                    ${lecture.notes ? `<p>${lecture.notes}</p>` : ''}
                    
                    <h6>Topics Covered:</h6>
                    <div class="mb-3">
                        ${(lecture.topics || []).map(topic => 
                            `<span class="badge bg-info me-1 mb-1">${topic.topic}</span>`
                        ).join('') || '<span class="text-muted">No topics specified</span>'}
                    </div>
                </div>
                
                <div class="col-md-6">
                    ${lecture.resource_type === 'youtube' ? `
                        <div class="ratio ratio-16x9">
                            <img src="https://img.youtube.com/vi/${lecture.resource_url.split('/').pop().split('=').pop().split('&')[0]}/maxresdefault.jpg" 
                                 class="rounded" alt="Video thumbnail">
                        </div>
                    ` : `
                        <div class="bg-dark text-center p-4 rounded">
                            <i class="fas fa-play-circle fa-4x text-primary mb-2"></i>
                            <p class="text-light">Video Lecture</p>
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;
}

function getPracticeQuestions(lectureId) {
    showToast('Loading practice questions for this lecture...', 'info');
    
    // Redirect to practice with lecture filter
    window.location.href = `/student/practice?lecture_id=${lectureId}`;
}

function addToWatchlist(lectureId) {
    // This would save to student's watchlist
    showToast('Added to your watchlist!', 'success');
}

function startPracticeFromLecture() {
    if (currentLectureId) {
        getPracticeQuestions(currentLectureId);
    }
}

function watchCurrentLecture() {
    if (currentLectureId) {
        bootstrap.Modal.getInstance(document.getElementById('lectureDetailsModal')).hide();
        setTimeout(() => watchLecture(currentLectureId), 300);
    }
}

function practiceQuestion(questionId) {
    window.location.href = `/student/practice?question_id=${questionId}`;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default for date filter
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateFilter').max = today;
    
    // Show helpful tips for new users
    setTimeout(() => {
        if ({{ lectures | length }} > 0) {
            showToast('💡 Tip: Watch lectures first, then practice the recommended questions for better understanding!', 'info', 6000);
        }
    }, 2000);
});
</script>
{% endblock %}
